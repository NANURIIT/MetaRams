<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nanuri.rams.business.common.mapper.IBIMS403BMapper">

    <select id="selectIBIMS403BList" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
    	  /* IBIMS403BMapper.selectIBIMS403BList */
          SELECT
                 PRDT_CD                                 /*상품코드 */
               , EXC_SN                                  /*실행일련번호 */
               , #{trSn} AS HGRK_TR_SN                   /*사거래일련번호 */
               , TR_SN                                   /*거래일련번호 */
               , SCX_DCD                                 /*일정구분코드 */
               , RDMP_TMRD                               /*상환회차 */
               , PRAR_DT                                 /*예정일자 */
               , PRAR_PRNA                               /*예정원금 */
               , STRT_DT                                 /*시작일자 */
               , END_DT                                  /*종료일자 */
               , RDMP_PRAR_INTR                          /*상환예정이자 */
               , PRCS_CPLT_YN                            /*처리완료여부 */
               , PRCS_DT                                 /*처리일자 */
               , PRCS_AMT                                /*처리금액 */
               , PRCS_INTR_AMT                           /*처리이자금액 */
               , APLY_IRT                                /*적용이율 */
               , OVDU_INTR_RT                            /*연체이자율 */
               , TRCH_DCD                                /*트렌치구분코드 */
               , HND_DETL_DTM                            /*조작상세일시 */
               , HND_EMPNO                               /*조작사원번호 */
               , HND_TMNL_NO                             /*조작단말기번호 */
               , HND_TR_ID                               /*조작거래id */
               , GUID                                    /*guid */
            FROM IBIMS403B /* 여신스케쥴기본 */
           WHERE PRDT_CD = #{prdtCd}        /* 상품코드 */
             AND EXC_SN  = #{excSn}         /* 실행일련번호 */
             ORDER BY SCX_DCD, PRAR_DT
    </select>
    <select id="getExcSn" resultType="long" parameterType="string">
    	/* IBIMS403BMapper.getExcSn */
		SELECT 
		       NVL(MAX(A.EXC_SN),0)+1 AS EXC_SN				/* 실행일련번호 채번 */
		  FROM IBIMS403B A 	/* 여신스케쥴기본 */
		 WHERE 1 = 1
		   AND A.PRDT_CD =  #{prdtCd} /*  'A000000001' */
    </select>
    
    <!-- 여신스케쥴기본등록  -->
    <insert id="saveRdmpInfo" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
    	/* IBIMS403BMapper.saveRdmpInfo */
        INSERT INTO IBIMS403B /* 여신스케쥴기본 */
               (
                  PRDT_CD                                 /*상품코드 */
                , EXC_SN                                  /*실행일련번호 */ 
                , SCX_DCD                                 /*일정구분코드 */ 
                , RDMP_TMRD                               /*상환회차 */ 
                , PRAR_DT                                 /*예정일자 */ 
                , TRGT_AMT                                /*대상금액*/
                , PRAR_PRNA                               /*예정원금 */ 
                , STRT_DT                                 /*시작일자 */ 
                , END_DT                                  /*종료일자 */ 
                , RDMP_PRAR_INTR                          /*상환예정이자 */ 
                , PRCS_CPLT_YN                            /*처리완료여부 */
                , PRCS_DT                                 /*처리일자 */ 
                , PRCS_AMT                                /*처리금액 */ 
                , PRCS_INTR_AMT                           /*처리이자금액 */ 
                , APLY_IRT                                /*적용이율 */ 
                , OVDU_INTR_RT                            /*연체이자율 */
                , TRCH_DCD                                /*트렌치구분코드 */
                , TR_SN                                   /*거래일련번호 */
                , HND_DETL_DTM                            /*조작상세일시 */
                , HND_EMPNO                               /*조작사원번호 */
                , HND_TMNL_NO                             /*조작단말기번호 */
                , HND_TR_ID                               /*조작거래id */
                , GUID                                    /*guid */
               )
        <foreach collection="list" item="item" separator="UNION ALL">
             select 
                 #{item.prdtCd, jdbcType=VARCHAR}
				, #{item.excSn, jdbcType=NUMERIC}
				, #{item.scxDcd, jdbcType=VARCHAR}
				, #{item.rdmpTmrd, jdbcType=VARCHAR}
				, #{item.prarDt, jdbcType=VARCHAR}
				, #{item.trgtAmt, jdbcType=NUMERIC} 
				, #{item.prarPrna, jdbcType=NUMERIC}
				, #{item.strtDt, jdbcType=VARCHAR}
				, #{item.endDt, jdbcType=VARCHAR}
				, TRUNC(#{item.rdmpPrarIntr, jdbcType=NUMERIC})
				, #{item.prcsCpltYn, jdbcType=VARCHAR}
				, #{item.prcsDt, jdbcType=VARCHAR}
				, #{item.prcsAmt, jdbcType=NUMERIC}
				, #{item.prcsIntrAmt, jdbcType=NUMERIC}
				, #{item.aplyIrt, jdbcType=NUMERIC}
				, #{item.ovduIntrRt, jdbcType=NUMERIC}
				, #{item.trchDcd, jdbcType=VARCHAR}
				, #{item.trSn, jdbcType=NUMERIC}
				, SYSDATE
				, #{item.hndEmpno, jdbcType=VARCHAR}
				, #{item.hndTmnlNo, jdbcType=VARCHAR}
				, #{item.hndTrId, jdbcType=VARCHAR}
				, #{item.guid, jdbcType=VARCHAR}
               from dual
        </foreach>
    </insert>

    <select id="getRdmpList" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
    	/* IBIMS403BMapper.getRdmpList */
		SELECT C.PRDT_CD            /* 상품코드 */
               , C.EXC_SN             /* 실행일련번호 */
               , A.PRAR_DT              /* 상환예정일자 */
               , C.EXP_DT             /* 만기일자 */
               , C.DEAL_EXC_BLCE      /* 실행잔액 */
               , NVL(A.PRAR_PRNA-A.PRCS_AMT, 0) AS PRAR_PRNA            /* 상환원금 */
               , NVL(A.RDMP_PRAR_INTR, 0)       AS RDMP_PRAR_INTR       /* 상환이자 */
              , 0 AS DEAL_MRDP_PRCA                               /* 딜중도상환원금 */                      
              , 0 AS MRDP_FEE_AMT                                 /* 중도상환수수료금액 */                   
             , NVL(C.RCVB_INTR_AMT, 0) AS RCVB_INTR_AMT           /* 미수이자금액 */       
             , 'N' AS EARLY_REPAY_YN                                /* 중도상환여부 */
             , NVL(D.MDWY_RDMP_FEE_RTO, 0) AS MDWY_RDMP_FEE_RTO   /* 중도상환수수료비율 */
            FROM IBIMS401B B       /* 여신기본 */
               inner join IBIMS402B C  /* 실행기본 */ on C.PRDT_CD = B.PRDT_CD
               left join  (
              SELECT PRDT_CD
                   , EXC_SN 
                   , MIN(PRAR_DT) AS PRAR_DT                     /* 예정일자 */
                   , SUM(NVL(PRAR_PRNA,0)) AS PRAR_PRNA     /* 예정원금 */
                   , SUM(NVL(PRCS_AMT,0)) AS PRCS_AMT  /* 처리금액 */
                   , SUM(NVL(RDMP_PRAR_INTR, 0)) AS RDMP_PRAR_INTR    /* 상환예정이자 */
                FROM IBIMS403B   /* 여신스케줄기본 */
               WHERE PRDT_CD     = #{prdtCd}                      
                 AND PRAR_DT  &lt;= #{prarDt} /* 상환일자 */
                 AND NVL(PRCS_CPLT_YN, 'N') = 'N' 
               GROUP BY PRDT_CD
                      , EXC_SN 
             ) A on C.PRDT_CD = A.PRDT_CD and C.EXC_SN  = A.EXC_SN
               left join IBIMS204B D /* 딜승인중도상환수수료설정기본 */ 
               on B.PRDT_CD = D.PRDT_CD 
               and D.FEE_SN  = NVL(( SELECT MAX(FEE_SN) FEE_SN 
                                           FROM IBIMS204B
                                          WHERE PRDT_CD       = #{prdtCd}   
                                            AND APLY_MNUM &lt;= (SELECT MONTHS_BETWEEN( SYSDATE, TO_DATE(V.CTRC_DT,'YYYYMMDD')) FROM IBIMS401B V WHERE PRDT_CD = #{prdtCd})     
                                           ), 0)
          WHERE 1 = 1
             AND B.PRDT_CD = #{prdtCd}     
             AND B.CTRC_CCLC_DCD = '1'   
             AND C.LDG_STTS_CD   = '1' 
          ORDER BY C.PRDT_CD 
                 , C.EXC_SN
    </select>

    <select id="getRdmpDetail" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
    	/* IBIMS403BMapper.getRdmpDetail */
  		SELECT  
	           A.PRDT_CD                    /* 상품코드 */
             , A.EXC_SN                     /* 실행일련번호 */
             , A.PRAR_DT                     /* 예정일자 */
             , CASE WHEN A.SCX_DCD = '02' THEN '1' /*원금 */
                    WHEN A.SCX_DCD = '04' THEN '2' /*정상이자 */                       
                    ELSE '99'
               END AS BSS_TYP_VAL            /* 원리금유형코드 */             
             , CASE WHEN A.SCX_DCD = '02' THEN
                        CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '1' /*원금 */
                             ELSE '5'  /*원금연체금액 */
                        END
                    WHEN A.SCX_DCD = '04' THEN
                        CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '2' /*정상이자 */
                             ELSE '4'  /*납부이자연체금액 */
                        END                         
                    ELSE '99'
               END AS PAI_TYP_CD            /* 원리금유형코드 */
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 4 /*원금 */
                            ELSE 3  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 2 /*정상이자 */
                            ELSE 1  /*납부이자연체금액 */
                       END                         
                   ELSE 5
              END AS PAI_TYP_VAL             /* 원리금유형코드 */                     
             , A.RDMP_TMRD                  /* 상환회차 */
             , A.SCX_DCD                    /* 일정구분코드 */
             , A.STRT_DT                    /* 시작일자 */
             , A.END_DT                     /* 종료일자 */
             , CASE WHEN LENGTH(A.END_DT)=8 AND LENGTH(A.STRT_DT)=8  THEN (TO_DATE(A.END_DT,'YYYYMMDD')-TO_DATE(A.STRT_DT,'YYYYMMDD'))+1 
               ELSE 0 END  AS INTR_APLY_DNUM /* 이자적용일수 */
             , NVL(B.FXN_INTRT,0)+NVL(B.ADD_INTRT,0) AS APLY_IRT /* 적용이율 */
             , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                         WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                         ELSE 0
               END, 0) AS TRGT_AMT                 /* 대상금액 = 예정원금 or 상환예정이자 */
            , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                         WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                         ELSE 0
               END, 0) AS PMNT_AMT                 /* 납부금액 */
             , A.PRAR_PRNA                  /* 예정원금 */
             , 0 AS EXMPT_AMT               /* 면제금액 */ 
             , A.PRAR_DT					/* 예정일자 */ 
             , A.RDMP_PRAR_INTR				/* 상환예정이자 */	
             , NVL(A.PRCS_CPLT_YN, 'N') AS PRCS_CPLT_YN	/* 처리완료여부 */
             , A.PRCS_INTR_AMT				/* 처리이자금액 */		
             , A.PRCS_DT					/* 처리일자 */		
             , A.OVDU_INTR_RT				/* 연체이자율 */	
             , A.TRCH_DCD                   /* 트렌치구분코드 */
             , A.TR_SN                      /* 거래일련번호 */	
		  FROM IBIMS403B  A /* 여신스케쥴기본 */
             , IBIMS404B  B /* 여신실행금리기본 */
		WHERE 1 = 1
	      AND A.PRDT_CD       = #{prdtCd}
	      AND A.EXC_SN          = #{excSn}
	      AND A.PRAR_DT &lt;= #{rkfrDt} /* 상환일자 */
	      AND NVL(PRCS_CPLT_YN, 'N') = 'N' 
	      AND #{dealMrdpPrca} &lt;= '0'			/* 중도상환금액이 없는경우 */
	      AND B.PRDT_CD = A.PRDT_CD 
	      AND B.EXC_SN  = A.EXC_SN 
		  AND A.PRAR_DT BETWEEN B.APLY_STRT_DT  AND  B.APLY_END_DT
		UNION ALL
	   SELECT 
	          A.PRDT_CD                     /* 상품코드 */
            , A.EXC_SN                      /* 실행일련번호 */
            , A.PRAR_DT                     /* 예정일자 */
            , CASE WHEN A.SCX_DCD = '02' THEN '1' /*원금 */
                   WHEN A.SCX_DCD = '04' THEN '2' /*정상이자 */                       
                   ELSE '99'
              END AS BSS_TYP_VAL            /* 원리금유형코드 */            
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '1' /*원금 */
                            ELSE '5'  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '2' /*정상이자 */
                            ELSE '4'  /*납부이자연체금액 */
                       END                         
                   ELSE '99'
              END AS PAI_TYP_CD             /* 원리금유형코드 */
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 4 /*원금 */
                            ELSE 3  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 2 /*정상이자 */
                            ELSE 1  /*납부이자연체금액 */
                       END                         
                   ELSE 5
              END AS PAI_TYP_VAL             /* 원리금유형코드 */                          
            , A.RDMP_TMRD                   /* 상환회차 */
            , A.SCX_DCD                     /* 일정구분코드 */
            , A.STRT_DT                     /* 시작일자 */
            , A.END_DT                      /* 종료일자 */
            , CASE WHEN LENGTH(A.END_DT)=8 AND LENGTH(A.STRT_DT)=8  THEN (TO_DATE(A.END_DT,'YYYYMMDD')-TO_DATE(A.STRT_DT,'YYYYMMDD'))+1 
               ELSE 0 END  AS INTR_APLY_DNUM /* 이자적용일수 */
            , NVL(B.FXN_INTRT,0)+NVL(B.ADD_INTRT,0) AS APLY_IRT /* 적용이율 */
            , NVL(
              CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                       WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                       ELSE 0
               END, 0) AS TRGT_AMT                 /* 대상금액 = 예정원금 or 상환예정이자 */
            , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN 0
                    WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                    ELSE 0
               END, 0) AS PMNT_AMT                      /* 납부금액 */         
            , A.PRAR_PRNA                   /* 예정원금 */
            , 0 AS EXMPT_AMT                /* 면제금액 */ 
            , A.PRAR_DT						/* 예정일자 */ 
            , A.RDMP_PRAR_INTR				/* 상환예정이자 */	
            , NVL(A.PRCS_CPLT_YN, 'N') AS PRCS_CPLT_YN	/* 처리완료여부 */
            , A.PRCS_INTR_AMT				/* 처리이자금액 */		
            , A.PRCS_DT						/* 처리일자 */		
            , A.OVDU_INTR_RT				/* 연체이자율 */	
            , A.TRCH_DCD                    /* 트렌치구분코드 */
            , A.TR_SN                       /* 거래일련번호 */	
         FROM IBIMS403B  A /* 여신스케쥴기본 */
            , IBIMS404B  B /* 여신실행금리기본 */
		WHERE 1=1 
	      AND A.PRDT_CD   = #{prdtCd}
	      AND A.EXC_SN      = #{excSn}
	      AND A.SCX_DCD   = '04'
	      AND A.PRAR_DT &lt;= #{rkfrDt} /* 상환일자 */	      
	      AND NVL(PRCS_CPLT_YN, 'N') = 'N' 
	      AND #{dealMrdpPrca} &gt; 0 					/* 중도상환금액이 있는경우  */
	      AND B.PRDT_CD = A.PRDT_CD 
	      AND B.EXC_SN  = A.EXC_SN 
		  AND A.PRAR_DT BETWEEN B.APLY_STRT_DT  AND  B.APLY_END_DT    
	   UNION ALL 
	   SELECT 
	          A.PRDT_CD                     /* 상품코드 */
            , A.EXC_SN                      /* 실행일련번호 */
            , A.PRAR_DT                     /* 예정일자 */
            , CASE WHEN A.SCX_DCD = '02' THEN '1'  /*원금 */
                   WHEN A.SCX_DCD = '04' THEN '2'  /*정상이자 */                       
                   ELSE '99'
              END AS BSS_TYP_VAL            /* 원리금유형코드 */            
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '1'  /*원금 */
                            ELSE '5'  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '2'  /*정상이자 */
                            ELSE '4'   /*납부이자연체금액 */
                       END                         
                   ELSE '99'
              END AS PAI_TYP_CD             /* 원리금유형코드 */
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 4  /*원금 */
                            ELSE 3   /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 2  /*정상이자 */
                            ELSE 1   /*납부이자연체금액 */
                       END                         
                   ELSE 5
              END AS PAI_TYP_VAL             /* 원리금유형코드 */                          
            , A.RDMP_TMRD                   /* 상환회차 */
            , A.SCX_DCD                     /* 일정구분코드 */
            , A.STRT_DT                     /* 시작일자 */
            , A.END_DT                      /* 종료일자 */
            , CASE WHEN LENGTH(A.END_DT)=8 AND LENGTH(A.STRT_DT)=8  THEN (TO_DATE(A.END_DT,'YYYYMMDD')-TO_DATE(A.STRT_DT,'YYYYMMDD'))+1 
               ELSE 0 END  AS INTR_APLY_DNUM /* 이자적용일수 */
            , NVL(B.FXN_INTRT,0)+NVL(B.ADD_INTRT,0) AS APLY_IRT /* 적용이율 */
            , NVL(
              CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                       WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                       ELSE 0
               END, 0) AS TRGT_AMT                 /* 대상금액 = 예정원금 or 상환예정이자 */
            , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN 0
                    WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                    ELSE 0
               END, 0) AS PMNT_AMT                      /* 납부금액 */         
            , A.PRAR_PRNA                   /* 예정원금 */
            , 0 AS EXMPT_AMT                /* 면제금액 */ 
            , A.PRAR_DT						/* 예정일자 */ 
            , A.RDMP_PRAR_INTR				/* 상환예정이자 */	
            , NVL(A.PRCS_CPLT_YN, 'N') AS PRCS_CPLT_YN	/* 처리완료여부 */
            , A.PRCS_INTR_AMT				/* 처리이자금액 */		
            , A.PRCS_DT						/* 처리일자 */		
            , A.OVDU_INTR_RT				/* 연체이자율 */	
            , A.TRCH_DCD                    /* 트렌치구분코드 */
            , A.TR_SN                       /* 거래일련번호 */	
         FROM IBIMS403B  A /* 여신스케쥴기본 */
            , IBIMS404B  B /* 여신실행금리기본 */
		WHERE 1=1 
	      AND A.PRDT_CD = #{prdtCd}
	      AND A.EXC_SN    = #{excSn}
	      AND A.SCX_DCD = '02' 
	      AND NVL(PRCS_CPLT_YN, 'N') = 'N' 
	      AND #{dealMrdpPrca} &gt; 0 					/* 중도상환금액이 있는경우  */
	      AND B.PRDT_CD = A.PRDT_CD 
	      AND B.EXC_SN  = A.EXC_SN 
		  AND A.PRAR_DT BETWEEN B.APLY_STRT_DT  AND  B.APLY_END_DT      
		ORDER BY PRDT_CD, EXC_SN, SCX_DCD DESC, LPAD(RDMP_TMRD, 3, '0'), PAI_TYP_VAL  
    </select>

    <update id="saveRdpm" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
    	/* IBIMS403BMapper.saveRdpm */
        <foreach collection="list" item="item" separator=";">        
          UPDATE IBIMS403B /* 여신스케쥴기본 */
             SET PRCS_CPLT_YN 	= #{item.prcsCpltYn} 		/* 처리완료여부 */
               , PRCS_DT 	     = #{item.prcsDt} 			/* 처리일자 */
               , PRCS_AMT 		= #{item.prcsAmt} 			/* 처리금액 */
               , PRCS_INTR_AMT 	= #{item.prcsIntrAmt} 		/* 처리이자금액 */
               , APLY_IRT 		= #{item.aplyIrt} 			/* 적용이율 */
               , OVDU_INTR_RT 	= #{item.ovduIntrRt} 		/* 연체이자율 */
               , TRCH_DCD 		= #{item.trchDcd} 			/* 트렌치구분코드 */
               , TR_SN 		     = NVL(#{item.trSn},0)	     /* 거래일련번호 */
               , HND_DETL_DTM 	= SYSDATE			  		/* 조작상세일시 */
           WHERE PRDT_CD           = #{item.prdtCd}  	          /* 상품코드 */
             AND EXC_SN            = #{item.excSn}               /* 실행일련번호 */
             AND SCX_DCD           = #{item.scxDcd} 	          /* 일정구분코드 */
             AND RDMP_TMRD         = #{item.rdmpTmrd}            /* 상환회차 */
		</foreach>
    </update>

    <update id="saveIBIMS403B" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
    	  /* IBIMS403BMapper.saveIBIMS403B */
          UPDATE IBIMS403B /* 여신스케쥴기본 */
             SET PRCS_CPLT_YN 	= #{prcsCpltYn} 		                  /* 처리완료여부 */
               , PRCS_DT 	      = #{prcsDt} 			                    /* 처리일자 */
               , PRCS_AMT 		  = #{prcsAmt} 			                    /* 처리금액 */
               , PRCS_INTR_AMT 	= #{prcsIntrAmt} 		                  /* 처리이자금액 */
               , APLY_IRT 		  = NVL(#{aplyIrt}   , APLY_IRT)	      /* 적용이율 */
               , OVDU_INTR_RT 	= NVL(#{ovduIntrRt}, OVDU_INTR_RT) 		/* 연체이자율 */
               , TRCH_DCD 		  = NVL(#{trchDcd}, TRCH_DCD)		        /* 트렌치구분코드 */
               , TR_SN 		      = NVL(#{trSn},0)	                    /* 거래일련번호 */
               , HND_DETL_DTM 	= SYSDATE			  	                    /* 조작상세일시 */
           WHERE PRDT_CD        = #{prdtCd}  	    	                  /* 상품코드 */
             AND EXC_SN         = #{excSn}           	                /* 실행일련번호 */
             AND SCX_DCD        = #{scxDcd} 	                        /* 일정구분코드 */
             AND RDMP_TMRD      = #{rdmpTmrd}        	                /* 상환회차 */
    </update>


     <!-- TB06015P 원금상환 계획 정보 조회 -->
     <select id='getRdmpSchedule' parameterType="com.nanuri.rams.business.common.vo.TB06015SVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
     	  /* IBIMS403BMapper.getRdmpSchedule */
          SELECT A.PRDT_CD                /* 종목코드 */
               , A.RDMP_TMRD              /* 상환회차 */
               , A.PRAR_DT                /* 예정일자 */
               , A.TRGT_AMT               /* 대상금액 */
               , A.PRAR_PRNA              /* 예정원금 */
               , A.STRT_DT                /* 시작일자 */
               , A.END_DT                 /* 종료일자 */
               , A.PRCS_DT                /* 처리일자 */
               , A.PRCS_AMT               /* 처리금액 */
               , A.PRCS_CPLT_YN           /* 처리여부 */
               , A.PRCS_DT                /* 처리일시 */
               , A.EXC_SN                 /* 실행일련번호 */
               , a.HND_DETL_DTM /*조작상세일시 */
               , (SELECT EMP_NM
	              FROM IBIMS003B
	             WHERE 1=1
	               AND EMPNO = HND_EMPNO
	            ) AS HND_EMPNO      /* 조작사원번호 */
            FROM IBIMS403B /* 여신스케쥴기본 */ A
           WHERE PRDT_CD = #{prdtCd}
          <if test="excSn != null and excSn != ''">
             AND EXC_SN = #{excSn}
          </if>
             AND SCX_DCD  = '02'
           ORDER BY STRT_DT ASC
     </select>

     <!-- TB06015P  이자상환 계획 정보 조회 -->
     <select id='getIntrSchedule' parameterType="com.nanuri.rams.business.common.vo.TB06015SVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
     	  /* IBIMS403BMapper.getIntrSchedule */
          SELECT A.PRDT_CD                /* 종목코드 */
               , A.RDMP_TMRD              /* 상환회차 */
               , A.PRAR_DT                /* 예정일자 */
               , A.TRGT_AMT               /* 대상금액 */
               , A.RDMP_PRAR_INTR         /* 상환예정이자 */
               , A.STRT_DT                /* 시작일자 */
               , A.END_DT                 /* 종료일자 */
               , A.PRAR_PRNA              /* 예정원금 */
               , A.APLY_IRT               /* 적용이율 */
               , A.PRCS_CPLT_YN           /* 처리여부 */
               , A.PRCS_DT                /* 처리일시 */
               , A.EXC_SN                 /* 실행일련번호 */
               , a.HND_DETL_DTM /*조작상세일시 */
			   , (SELECT EMP_NM
	              FROM IBIMS003B
	             WHERE 1=1
	               AND EMPNO = HND_EMPNO
	            ) AS HND_EMPNO      /* 조작사원번호 */
            FROM IBIMS403B /* 여신스케쥴기본 */ A
           WHERE PRDT_CD = #{prdtCd}
          <if test="excSn != null and excSn != ''">
             AND EXC_SN = #{excSn}
          </if>
             AND SCX_DCD  = '04'
           ORDER BY STRT_DT ASC
     </select>

     <!-- TB07050S  실행스케줄 조회 -->
     <select id='getExcSchedule' parameterType="com.nanuri.rams.business.common.vo.TB06015SVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
     	  /* IBIMS403BMapper.getExcSchedule */
          SELECT PRDT_CD                /* 종목코드 */
               , RDMP_TMRD              /* 상환회차 */
               , PRAR_DT                /* 예정일자 */
               , PRAR_PRNA              /* 예정원금 */
               , PRCS_CPLT_YN           /* 처리여부 */
               , PRCS_DT                /* 처리일시 */
               , EXC_SN                 /* 실행일련번호 */
               , a.HND_DETL_DTM /*조작상세일시 */
               , (SELECT EMP_NM
	              FROM IBIMS003B
	             WHERE 1=1
	               AND EMPNO = HND_EMPNO
	            ) AS HND_EMPNO      /* 조작사원번호 */
            FROM IBIMS403B /* 여신스케쥴기본 */ A
           WHERE PRDT_CD = #{prdtCd}
             AND SCX_DCD  = '01'
           ORDER BY PRAR_DT DESC
     </select>

     <!-- 여신스케쥴기본등록   -->
     <insert id="insertCrdlSchBss" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
     	/* IBIMS403BMapper.insertCrdlSchBss */
        INSERT INTO IBIMS403B /* 여신스케쥴기본 */
               (
                  PRDT_CD                             /* 상품코드 */
                , EXC_SN                              /* 실행일련번호 */
                , SCX_DCD                             /* 일정구분코드 */
                , RDMP_TMRD                           /* 상환회차 */
                , PRAR_DT                             /* 예정일자 */
                , TRGT_AMT                            /* 대상금액*/
                , PRAR_PRNA                           /* 예정원금 */
                , STRT_DT                             /* 시작일자 */
                , END_DT                              /* 종료일자 */
                , RDMP_PRAR_INTR                      /* 상환예정이자 */
                , PRCS_CPLT_YN                        /* 처리완료여부 */
                , PRCS_DT                             /* 처리일자 */
                , PRCS_AMT                            /* 처리금액 */
                , PRCS_INTR_AMT                       /* 처리이자금액 */
                , APLY_IRT                            /* 적용이율 */
                , OVDU_INTR_RT                        /* 연체이자율 */
                , TRCH_DCD                            /* 트렌치구분코드 */
                , TR_SN                               /* 거래일련번호 */
                , HND_DETL_DTM                        /* 조작상세일시 */
                , HND_EMPNO                           /* 조작사원번호 */
                , HND_TMNL_NO                         /* 조작단말기번호 */
                , HND_TR_ID                           /* 조작거래id */
                , GUID                                /* guid */
               )
        VALUES
               (
                 #{prdtCd}                           /*상품코드 */
               , #{excSn}                            /*실행일련번호 */
               , #{scxDcd}                           /*일정구분코드 */
               , #{rdmpTmrd}                         /*상환회차 */
               , #{prarDt}                           /*예정일자 */
               , #{trgtAmt}                          /* 대상금액 */
               , #{prarPrna}                         /*예정원금 */
               , #{strtDt}                           /*시작일자 */
               , #{endDt}                            /*종료일자 */
               , TRUNC(#{rdmpPrarIntr})                     /*상환예정이자 */
               , #{prcsCpltYn}                       /*처리완료여부 */
               , #{prcsDt}        /*처리일자 */
               , #{prcsAmt}                          /*처리금액 */
               , #{prcsIntrAmt}                      /*처리이자금액 */
               , #{aplyIrt}                          /*적용이율 */
               , #{ovduIntrRt}                       /*연체이자율 */
               , #{trchDcd}                          /*트렌치구분코드 */
               , #{trSn}                             /*거래일련번호 */
               , SYSDATE                             /*조작상세일시 */
               , #{hndEmpno}                         /*조작사원번호 */
               , #{hndTmnlNo}                        /*조작단말기번호 */
               , #{hndTrId}                          /*조작거래id */
               , #{guid}                             /*guid */
               )
     </insert>

     <!-- 원리금  스케줄관리 업데이트 -->
     <update  id="updateCrdlSchBss" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
     	  /* IBIMS403BMapper.updateCrdlSchBss */
          UPDATE IBIMS403B /* 여신스케쥴기본 */
             SET PRAR_DT           = #{prarDt}                     /* 예정일자 */
               , TRGT_AMT          = #{trgtAmt}                    /* 대상금액 */ 
               , PRAR_PRNA         = #{prarPrna}                   /* 예정원금 */
               , STRT_DT           = #{strtDt}                     /* 시작일자 */
               , END_DT            = #{endDt}                      /* 종료일자 */
               , RDMP_PRAR_INTR    = #{rdmpPrarIntr}               /* 상환예정이자 */
               , PRCS_CPLT_YN 	   = #{prcsCpltYn} 		             /* 처리완료여부 */
               , PRCS_DT 	         = #{prcsDt}  /* 처리일자 */
               , PRCS_AMT 		     = #{prcsAmt} 			             /* 처리금액 */
               , PRCS_INTR_AMT 	   = #{prcsIntrAmt} 	    	       /* 처리이자금액 */
               , APLY_IRT 		     = #{aplyIrt} 			             /* 적용이율 */
               , OVDU_INTR_RT 	   = #{ovduIntrRt} 		             /* 연체이자율 */
               , TRCH_DCD 		     = #{trchDcd} 			             /* 트렌치구분코드 */
               , TR_SN 		         = NVL(#{trSn},0)	           /* 거래일련번호 */
               , HND_DETL_DTM 	   = SYSDATE 		       /* 조작상세일시 */
           WHERE PRDT_CD           = #{prdtCd}  	                 /* 상품코드 */
             AND EXC_SN            = #{excSn}                      /* 실행일련번호 */
             AND SCX_DCD           = #{scxDcd} 	                   /* 일정구분코드 */
             AND RDMP_TMRD         = #{rdmpTmrd}                   /* 상환회차 */
     </update>

     <!-- 원리금  스케줄관리 실행일련번호 조회 -->
     <select id="srchExcSn" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="java.util.HashMap">
     	  /* IBIMS403BMapper.srchExcSn */
          SELECT DISTINCT(EXC_SN)              /* 실행일련번호 */
            FROM IBIMS403B /* 여신스케쥴기본 */
           WHERE PRDT_CD = #{prdtCd}           /* 종목코드 */
           <if test="scxDcd != null"> 
             AND SCX_DCD = #{scxDcd}           /* 일정구분코드 */
            </if>
           ORDER
              BY EXC_SN DESC
     </select>

     <!-- 원리금  스케줄관리 삭제 -->
     <delete  id="deleteCrdlSchBss" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
     	  /* IBIMS403BMapper.deleteCrdlSchBss */
          DELETE 
            FROM IBIMS403B /* 여신스케쥴기본 */
           WHERE PRDT_CD   = #{prdtCd}     /* 종목코드 */
             AND RDMP_TMRD = #{rdmpTmrd}   /* 상환회차 */
             AND SCX_DCD   = #{scxDcd}     /* 일정구분코드 */
             AND EXC_SN    = #{excSn}      /* 실행일련번호 */
     </delete>


     <!-- 원리금  스케줄관리 삭제 -->
     <delete  id="deleteIBIMS403B" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
     	  /* IBIMS403BMapper.deleteIBIMS403B */
          DELETE 
            FROM IBIMS403B /* 여신스케쥴기본 */
           WHERE PRDT_CD   = #{prdtCd}     /* 종목코드 */
             AND EXC_SN    = #{excSn}      /* 실행일련번호 */
     </delete>
     
     <!-- 원리금  스케줄관리 회차 채번 -->
     <select id="getPaiSchTmrd" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="String">
     	/* IBIMS403BMapper.getPaiSchTmrd */
        SELECT TO_CHAR(nvl(max(RDMP_TMRD),0)+1) AS rdmpTmrd /* 상환회차 */
          FROM IBIMS403B /* 여신스케쥴기본 */
         WHERE PRDT_CD = #{prdtCd}     /* 종목코드 */
           AND SCX_DCD = #{scxDcd}     /* 일정구분코드 */
           AND EXC_SN  = #{excSn}      /* 실행일련번호 */
     </select>

     <!-- 실행  스케줄관리 실행일련번호 채번 -->
     <select id="getExcSchExcSn" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="long">
     	/* IBIMS403BMapper.getExcSchExcSn */
        SELECT NVL(MAX(NVL(nvl(EXC_SN, 0), 0)), 0) + 1 AS EXC_SN
          FROM IBIMS403B /* 여신스케쥴기본 */
         WHERE PRDT_CD  = #{prdtCd}
           AND SCX_DCD  = #{scxDcd}
     </select>

    <!--입금내역관리 상환예정내역 조회-->
    <select id="getRdmpPrarDtls" parameterType="com.nanuri.rams.business.common.vo.IBIMS430BVO" resultType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
    	  /* IBIMS403BMapper.getRdmpPrarDtls */
	      SELECT CASE
	             WHEN TT1.SCX_DCD = '02'
	             THEN TT1.PRAR_PRNA
	             ELSE TT1.RDMP_PRAR_INTR
	              END                   AS PMNT_PRAR_AMT			  /* 납부예정금액 */
	           , nvl(tt3.DEAL_RCTM_AMT,0)  AS DEAL_RCTM_AMT 
	           , TT1.PRAR_DT 				    AS PRAR_DT              /* 상환예정일자 */
	           , TT2.DEAL_NO 				    AS DEAL_NO              /* 딜번호 */
	           , TT1.PRDT_CD            AS PRDT_CD              /* 상품코드 */ 
	           , TT1.EXC_SN             AS EXC_SN               /* 실행일련번호 */
	           , TT1.TR_SN              AS TR_SN                /* 거래일련번호 */
	           , TT1.RDMP_TMRD          AS RDMP_TMRD            /* 상환회차 */
	           , 0                      AS FEE_SN               /* 수수료일련번호 */
	           , TT2.MNGM_BDCD 			                            /* 관리부서 */
	           , TT1.SCX_DCD 				                            /* 상환구분 */
	           , TT2.TR_CRRY_CD 			                          /* 통화코드 */
	        FROM IBIMS403B TT1	/* 여신스케쥴기본 */
	   LEFT JOIN IBIMS201B TT2  /* 딜승인기본 */ ON TT1.PRDT_CD = TT2.PRDT_CD
	   LEFT JOIN ibims430b tt3 ON tt3.PRDT_CD = tt1.PRDT_CD AND tt3.SCX_DCD = tt1.SCX_DCD AND tt3.PRAR_DT = tt1.PRAR_DT
	       WHERE 1=1
	         AND TT2.LAST_YN = 'Y'
	         AND (TT1.PRCS_CPLT_YN != 'Y' OR TT1.PRCS_CPLT_YN IS NULL)
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dealNo)">
	         AND TT2.DEAL_NO  = #{dealNo}
	         </if>
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dprtCd)">
	         AND TT2.MNGM_BDCD = #{dprtCd}
	         </if>
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(fromDt)">
	         AND TT1.PRAR_DT &gt;= #{fromDt} 
	         </if>
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(toDt)">
	         AND TT1.PRAR_DT &lt;= #{toDt} 
	         </if>
	       UNION ALL
	      SELECT BT2.FEE_AMT				  AS PMNT_PRAR_AMT	        /* 납부예정금액 */
	      	   , 0
	           , BT2.PRAR_DT          AS PRAR_DT                /* 상환예정일자 */
	           , BT3.DEAL_NO          AS DEAL_NO                /* 딜번호 */
	           , BT2.PRDT_CD          AS PRDT_CD                /* 상품코드 */ 
	           , BT1.EXC_SN           AS EXC_SN                 /* 수수료일련번호 */
	           , BT1.TR_SN            AS TR_SN                  /* 거래일련번호 */
	           , '0'                  AS RDMP_TMRD              /* 상환회차 */
	           , BT1.FEE_SN           AS FEE_SN                 /* 수수료일련번호 */
	           , BT3.MNGM_BDCD                                  /* 관리부서 */
	           , '03'					        AS SCX_DCD                /* 상환구분 */
	           , BT3.TR_CRRY_CD                                 /* 통화코드 */
	        FROM IBIMS420B BT1 /* 딜수수료수납내역 */
	  INNER JOIN IBIMS348B BT2 /* 딜승인수수료스케쥴기본 */
	          ON BT1.PRDT_CD = BT2.PRDT_CD
	         AND BT1.FEE_SN = BT2.FEE_SN
	   LEFT JOIN IBIMS201B BT3
	          ON BT1.PRDT_CD = BT3.PRDT_CD
	       WHERE 1=1
	         AND BT3.LAST_YN = 'Y'
	         AND (BT2.PRCS_CPLT_YN != 'Y' OR BT2.PRCS_CPLT_YN IS NULL)
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dealNo)">
	         AND BT3.DEAL_NO  = #{dealNo}
	         </if>
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dprtCd)">
	         AND BT3.MNGM_BDCD = #{dprtCd}
	         </if>
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(fromDt)">
	         AND BT2.PRAR_DT &gt;= #{fromDt} 
	         </if>
	         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(toDt)">
	         AND BT2.PRAR_DT &lt;= #{toDt} 
	         </if>
	       ORDER BY PRAR_DT
    </select>

    <!--상환대상내역 조회-->
    <select id="rdmpTrgtDtlsInq" parameterType="com.nanuri.rams.business.common.vo.TB09070SVO" resultType="com.nanuri.rams.business.common.vo.TB09070SVO$RdmpTrgtDtlsVO">
    	/* IBIMS403BMapper.rdmpTrgtDtlsInq */
      	SELECT DISTINCT   A.PRAR_PRNA                     /*상환예정원금*/
                      , A.RDMP_PRAR_INTR                /*상환예정이자*/      
                      , A.PMNT_PRAR_AMT                 /*납부예정금액*/		
                      , CASE WHEN LENGTH(A.PRAR_DT)=8 
                        THEN TO_CHAR(TO_DATE(A.PRAR_DT, 'YYYYMMDD'), 'YYYY-MM-DD') 
                        ELSE '' 
                        END AS PRAR_DT                  /*예정일자*/   
                      , B.ACTS_CD                       /*계정과목코드*/
                      , B.MNGM_BDCD                     /*관리부점코드*/
                      , C.ORTN_FND_CD                   /*운용펀드코드*/
                      , ( SELECT fnd.FND_NM 
                        FROM IBIMS993B fnd 
                        WHERE fnd.FND_CD = C.ORTN_FND_CD) 
                        AS FND_NM                       /*운용펀드명*/
                      , C.TR_CRRY_CD                    /*통화코드*/
                      , C.DEAL_NO                       /*딜번호*/
                      , C.DEAL_NM                       /*딜명*/
                      , A.PRDT_CD                       /*종목코드*/
                      , A.EXC_SN                        /*실행일련번호*/
                      , C.PRDT_NM                       /*종목명*/
                      , (SELECT ENTP_NM 
                        FROM IBIMS010B 
                        WHERE ARDY_BZEP_NO = B.PTXT_TR_OTHR_DSCM_NO) 
                        AS TR_OBJT_BSN_NO               /*거래대상기업체번호*/
                      , '0' AS ovduIntr
                      , '0' AS rcvbIntr
                      , '0' AS totalFee     /*todo: 연체, 미수이자, 수수료총금액 배치 완료 후 쿼리 수정해야함*/
          FROM (SELECT A.PRAR_DT, A.PRDT_CD, A.EXC_SN, A.PRCS_CPLT_YN, 
                      SUM(COALESCE(A.PRAR_PRNA, 0)) AS PRAR_PRNA,
                      SUM(COALESCE(A.RDMP_PRAR_INTR, 0)) AS RDMP_PRAR_INTR,
                      (SUM(COALESCE(A.PRAR_PRNA, 0)) + SUM(COALESCE(A.RDMP_PRAR_INTR, 0))) AS PMNT_PRAR_AMT
                FROM IBIMS403B /* 여신스케쥴기본 */ A
                WHERE (A.PRCS_CPLT_YN &lt;&gt; 'Y' OR A.PRCS_CPLT_YN IS NULL)
                GROUP BY A.PRAR_DT, A.PRDT_CD, A.EXC_SN, A.PRCS_CPLT_YN) A
          JOIN IBIMS401B B ON B.PRDT_CD = A.PRDT_CD
          JOIN IBIMS201B C ON C.PRDT_CD = A.PRDT_CD AND C.LAST_YN = 'Y'
          JOIN IBIMS410B D ON D.PRDT_CD = A.PRDT_CD
          WHERE 1=1		
          <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(mngmBdcd)">
          AND B.MNGM_BDCD = #{mngmBdcd}
          </if>
          <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(actsCd)">
          AND B.ACTS_CD = #{actsCd}
          </if>
          <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dealNo)">
          AND C.DEAL_NO = #{dealNo}
          </if>
          <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(prdtCd)">
          AND A.PRDT_CD = #{prdtCd}
          </if>
          <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(trObjtBsnNo)">
          AND D.TR_OBJT_BSN_NO = #{trObjtBsnNo}
          </if>
          <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(fromDt)">
          AND A.PRAR_DT &gt;= #{fromDt} 
          </if>
          <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(toDt)">
          AND A.PRAR_DT &lt;= #{toDt} 
          </if>
          ORDER BY PRAR_DT, C.DEAL_NO, A.PRDT_CD, A.EXC_SN 
    </select>

    <!--중도상환 발생 시 새로운 스케줄 생성-->
    <insert id="rgstNewScdl" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
    	/* IBIMS403BMapper.rgstNewScdl */
      	INSERT INTO IBIMS403B /* 여신스케쥴기본 */
              (
                  PRDT_CD                                 /*상품코드 */
                , EXC_SN                                  /*실행일련번호 */
                , SCX_DCD                                 /*일정구분코드 */ 
                , RDMP_TMRD                               /*상환회차 */ 
                , PRAR_DT                                 /*예정일자 */
                , TRGT_AMT                                /*대상금액*/
                , PRAR_PRNA                               /*예정원금 */ 
                , STRT_DT                                 /*시작일자 */ 
                , END_DT                                  /*종료일자 */
                , RDMP_PRAR_INTR                          /*상환예정이자 */
                , PRCS_CPLT_YN                            /*처리완료여부 */ 
                , PRCS_DT                                 /*처리일자 */ 
                , PRCS_AMT                                /*처리금액 */
                , PRCS_INTR_AMT                           /*처리이자금액 */ 
                , APLY_IRT                                /*적용이율 */ 
                , OVDU_INTR_RT                            /*연체이자율 */ 
                , TRCH_DCD                                /*트렌치구분코드 */ 
                , TR_SN                                   /*거래일련번호 */ 
                , HND_DETL_DTM                            /*조작상세일시 */ 
                , HND_EMPNO                               /*조작사원번호 */ 
                , HND_TMNL_NO                             /*조작단말기번호 */ 
                , HND_TR_ID                               /*조작거래id */ 
                , GUID                                    /*guid */ 
              )
        VALUES
              (
                 #{prdtCd}                                /*상품코드 */
               , #{excSn}                                 /*실행일련번호 */
               , #{scxDcd}                                /*일정구분코드 */
               , #{rdmpTmrd}                              /*상환회차 */
               , #{prarDt}                                /*예정일자 */
               , #{trgtAmt}                               /* 대상금액 */
               , #{prarPrna}                              /*예정원금 */
               , #{strtDt}                                /*시작일자 */
               , #{endDt}                                 /*종료일자 */
               , TRUNC(#{rdmpPrarIntr})                          /*상환예정이자 */
               , #{prcsCpltYn}                            /*처리완료여부 */
               , #{prcsDt}                                /*처리일자 */
               , #{prcsAmt}                               /*처리금액 */
               , #{prcsIntrAmt}                           /*처리이자금액 */
               , #{aplyIrt}                               /*적용이율 */
               , #{ovduIntrRt}                            /*연체이자율 */
               , #{trchDcd}                               /*트렌치구분코드 */
               , #{trSn}                                  /*거래일련번호 */
               , SYSDATE                                  /*조작상세일시 */
               , #{hndEmpno}                              /*조작사원번호 */
               , #{hndTmnlNo}                             /*조작단말기번호 */
               , #{hndTrId}                               /*조작거래id */
               , #{guid}                                  /*guid */
              )
    </insert>

    <select id="getBfScdhl" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
    	  /* IBIMS403BMapper.getBfScdhl */
	      SELECT 
	          PRDT_CD,
	          EXC_SN,
	          SCX_DCD,
	          RDMP_TMRD,
	          PRAR_DT,
	          TRGT_AMT,
	          PRAR_PRNA,
	          STRT_DT,
	          END_DT,
	          RDMP_PRAR_INTR,
	          'N' AS PRCS_CPLT_YN,
	          NULL AS PRCS_DT,
	          NULL AS PRCS_AMT,
	          NULL AS PRCS_INTR_AMT,
	          ACTS_CD,
	          APLY_IRT,
	          OVDU_INTR_RT,
	          TRCH_DCD,
	          TR_SN,
	          #{hndEmpno} AS HND_EMPNO
	      FROM IBIMS403B /* 여신스케쥴기본 */ 
	      WHERE PRDT_CD = #{prdtCd}
	      AND EXC_SN = #{excSn}
	      AND TR_SN = #{hgrkTrSn}
    </select>

    <delete  id="deleteBfIBIMS403B" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
    	  /* IBIMS403BMapper.deleteBfIBIMS403B */
          DELETE 
            FROM IBIMS403B /* 여신스케쥴기본 */
           WHERE PRDT_CD   = #{prdtCd}     /* 종목코드 */
             AND EXC_SN    = #{excSn}      /* 실행일련번호 */
             AND TR_SN     = #{hgrkTrSn}
     </delete>
</mapper>