<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nanuri.rams.business.common.mapper.IBIMS231BMapper">

  <!-- 승인요청 조회 -->
	<select id='inqTB06080S' parameterType="com.nanuri.rams.business.common.dto.IBIMS231BDTO" resultType="com.nanuri.rams.business.common.vo.IBIMS231BVO">
        SELECT T1.DECD_SN
             , T1.CHRR_ENO
             , (
              SELECT EMP_NM
                FROM IBIMS003B
               WHERE 1=1
                 AND EMPNO = T1.CHRR_ENO
             ) AS CHRR_NM
             , T1.APVL_RQST_P_ENO
             , (
              SELECT EMP_NM
                FROM IBIMS003B
               WHERE 1=1
                 AND EMPNO = T1.APVL_RQST_P_ENO
             ) AS APVL_RQST_P_NM
             , T1.DECD_STEP_DCD
             , (
              SELECT CD_VL_NM
                FROM IBIMS002B
               WHERE 1=1
                 AND CMNS_CD_GRP = 'D016'
                 AND CD_VL_ID = T1.DECD_STEP_DCD
             ) AS DECD_STEP_NM
             , T1.DECD_STTS_DCD
             , (
              SELECT CD_VL_NM
                FROM IBIMS002B
               WHERE 1=1
                 AND CMNS_CD_GRP = 'D006'
                 AND CD_VL_ID = T1.DECD_STTS_DCD
             ) AS DECD_STTS_NM
             , T1.DEAL_NO
             , (
              SELECT MAX(DEAL_NM)
                FROM IBIMS101B
               WHERE 1=1
                 AND DEAL_NO = T1.DEAL_NO
             ) AS DEAL_NM
             , T1.PRDT_CD
             , (
              SELECT MAX(PRDT_NM)
                FROM IBIMS201B
               WHERE 1=1
                 AND PRDT_CD = T1.PRDT_CD
             ) AS PRDT_NM
             , T1.DECD_JOB_DCD
             , T1.SCRN_NO
             , T1.APVL_RQST_CNTN
             , T1.RQST_DTM
             , T1.RQST_CNCL_DTM
             , T1.PRCS_RSLT_DCD
             , (
              SELECT CD_VL_NM
                FROM IBIMS002B
               WHERE 1=1
                 AND CMNS_CD_GRP = 'P028'
                 AND CD_VL_ID = T1.PRCS_RSLT_DCD
             ) AS PRCS_RSLT_NM
             , T1.EXC_SEQ
             , T1.RQST_SQ
             , T1.TR_SEQ
             , T1.ERR_CNTN
             , T1.LAST_DECD_SQ
             , T2.DPRT_NM
          FROM IBIMS231B T1
     LEFT JOIN IBIMS003B T2
            ON T1.APVL_RQST_P_ENO = T2.EMPNO
         WHERE 1=1
           <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(decdStepDcd)">
           AND T1.DECD_STEP_DCD = #{decdStepDcd}					/* 결재단계구분코드 */
           </if>
           <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(chrrEno)">
           AND T1.CHRR_ENO = #{chrrEno}                   /* 책임자 */
           </if>
           <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(apvlRqstPEno)">
           AND T1.APVL_RQST_P_ENO = #{apvlRqstPEno}       /* 승인요청자 */
           </if>
           <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(hndEmpno)">
           AND (
             /* 승인요청자가 접속한 경우 */
             T1.APVL_RQST_P_ENO = #{hndEmpno}					
             /* 결재자가 접속한 경우 */
             OR T1.DECD_SN IN (
                   SELECT DECD_SN
                     FROM IBIMS232B
                    WHERE 1=1
                      AND DCFC_ENO = #{hndEmpno}		
             )
               /* 현재 접속자가 상급자중 부서장 이상인 경우도 검색 가능 */
             OR (
                8 &gt;= SUBSTR(T2.ATH_CD, 4)
            AND T2.DPRT_CD = (
                      SELECT DPRT_CD
                        FROM IBIMS003B
                      WHERE 1=1
                        AND EMPNO = #{hndEmpno}
                    )
              )
           )
           </if>
	</select>

  <!-- 결재요청내역 확인 -->
  <select id="apvlListChk" parameterType="com.nanuri.rams.business.common.dto.IBIMS231BDTO" resultType="com.nanuri.rams.business.common.vo.IBIMS003BVO">
      SELECT T2.EMPNO							/* 사원번호 */
     	     , T2.EMP_NM						/* 직원명 */
     	     , T2.DPRT_NM						/* 부서명 */
     	     , (
              SELECT S1.ATH_CD_NM
                FROM IBIMS006B S1
               WHERE 1=1
                 AND S1.ATH_CD = T2.ATH_CD
              ) AS ATH_CD_NM				/* 직책 */
           , T1.APVL_RQST_CNTN
           , T1.ERR_CNTN
           , T1.DECD_SQ
           , T1.DECD_STTS_DCD
     	  FROM (
              SELECT B.DCFC_ENO
                   , A.APVL_RQST_CNTN
                   , A.ERR_CNTN
                   , B.DECD_SQ
                   , B.DECD_STTS_DCD
                FROM IBIMS231B A
           LEFT JOIN IBIMS232B B
                  ON A.DECD_SN = B.DECD_SN
               WHERE 1=1
                 AND A.DEAL_NO = #{dealNo}
                 AND A.PRDT_CD = #{prdtCd}
                 AND A.DECD_JOB_DCD = (
                                        SELECT CD_VL_ID
                                          FROM IBIMS002B
                                         WHERE 1=1
                                           AND CMNS_CD_GRP = 'D005'
                                           AND RSLT_CD_VL = #{decdJobDcd}
                                        )
                 AND A.SCRN_NO = #{scrnNo}
                 AND A.EXC_SEQ = #{excSeq}
                 AND A.RQST_SQ = #{rqstSq}
                 AND A.TR_SEQ = #{trSeq}
                 AND A.RQST_CNCL_DTM IS NULL
                 AND A.PRCS_RSLT_DCD = '00'
              ) T1
   LEFT JOIN IBIMS003B T2
          ON T1.DCFC_ENO = T2.EMPNO
     	 WHERE 1=1
       ORDER
          BY DECD_SQ DESC
  </select>

  <select id="getDecdSn" resultType="int">
    SELECT NVL(MAX(DECD_SN) + 1, 1)
      FROM IBIMS231B
     WHERE 1=1
  </select>

  <select id="decdSn" resultType="int">
    SELECT DECD_SN
      FROM IBIMS231B
     WHERE 1=1
       AND DEAL_NO = #{dealNo}
       AND PRDT_CD = #{prdtCd}
       AND DECD_JOB_DCD = (
                             SELECT CD_VL_ID
                               FROM IBIMS002B
                             WHERE 1=1
                               AND CMNS_CD_GRP = 'D005'
                               AND RSLT_CD_VL = #{decdJobDcd}
                             )
       AND SCRN_NO = #{scrnNo}
       AND EXC_SEQ = #{excSeq}
       AND RQST_SQ = #{rqstSq}
       AND TR_SEQ = #{trSeq}
       AND RQST_CNCL_DTM IS NULL
       AND PRCS_RSLT_DCD = '00'
  </select>

  <!-- 결재단계체크 -->
  <select id="chkDecdStep" parameterType="com.nanuri.rams.business.common.vo.IBIMS231BVO" resultType="String">
    		SELECT NVL(MAX(
                  CASE WHEN
                      (
                        SELECT DECODE(COUNT(*), 0, 'Y', DECODE(NVL(SUM(DECODE(DECD_STTS_DCD, '2', 1, 0)), 0), COUNT(*), 'Y', 'N'))
                        FROM IBIMS232B
                        WHERE 1=1
                        AND DECD_SN = T2.DECD_SN
                        AND DECD_SQ &lt; T2.DECD_SQ
                      ) = 'N' THEN '0' ELSE T2.DECD_STTS_DCD END
                  ), '0')AS DECD_STTS_DCD
    		  FROM IBIMS231B T1
     LEFT JOIN IBIMS232B T2
    	 		  ON T1.DECD_SN = T2.DECD_SN
    		 WHERE 1=1
    		   AND T1.DEAL_NO = #{dealNo}
    		   AND T1.PRDT_CD = #{prdtCd}
    		   AND T1.DECD_JOB_DCD = (
    		   						  SELECT CD_VL_ID
    		   						    FROM IBIMS002B
    		   						   WHERE 1=1
    		   						     AND CMNS_CD_GRP = 'D005'
    		   						     AND RSLT_CD_VL = #{decdJobDcd}
    		   						  )
    		   AND T1.SCRN_NO = #{scrnNo}
    		   AND T1.EXC_SEQ = #{excSeq}
    		   AND T1.RQST_SQ = #{rqstSq}
    		   AND T1.TR_SEQ = #{trSeq}
    		   AND T1.RQST_CNCL_DTM IS NULL
    		   AND T1.PRCS_RSLT_DCD = '00'
           AND T2.DCFC_ENO = #{dcfcEno}
           /* 결재자이긴한데 현재 결재순서가 아닌경우 결재요청 버튼도 보여주면 안됨 */
	</select>

  <select id="getLastDecdSq" parameterType="int" resultType="int">
    SELECT LAST_DECD_SQ
      FROM IBIMS231B
     WHERE 1=1
       AND DECD_SN = #{decdSn}
  </select>
  <!-- 결재요청 -->
  <insert id="apvlRqst" parameterType="com.nanuri.rams.business.common.dto.IBIMS231BDTO">
    INSERT INTO IBIMS231B(
        DECD_SN
      , CHRR_ENO
      , APVL_RQST_P_ENO
      , DECD_STEP_DCD
      , DECD_STTS_DCD
      , DEAL_NO
      , PRDT_CD
      , DECD_JOB_DCD
      , SCRN_NO
      , APVL_RQST_CNTN
      , RQST_DTM
      , RQST_CNCL_DTM
      , PRCS_RSLT_DCD
      , EXC_SEQ
      , RQST_SQ
      , TR_SEQ
      , ERR_CNTN
      , LAST_DECD_SQ
      , HND_DETL_DTM
      , HND_EMPNO
      , HND_TMNL_NO
      , HND_TR_ID
      , GUID
    ) VALUES (
        #{decdSn}
      , (
        SELECT MAX(EMPNO)
          FROM IBIMS003B
         WHERE 1=1
           AND ATH_CD = (
                          SELECT DPRT_CD || 8
                            FROM IBIMS003B
                           WHERE 1=1
                             AND EMPNO = #{apvlRqstPEno}
                         )
      )
      , #{apvlRqstPEno}
      , #{decdStepDcd}
      , #{decdSttsDcd}
      , #{dealNo}
      , #{prdtCd}
      , (
         SELECT CD_VL_ID
           FROM IBIMS002B
          WHERE 1=1
            AND CMNS_CD_GRP = 'D005'
            AND RSLT_CD_VL = #{decdJobDcd}
         )
      , #{scrnNo}
      , #{apvlRqstCntn}
      , SYSDATE
      , #{rqstCnclDtm}
      , '00'
      , #{excSeq}
      , #{rqstSq}
      , #{trSeq}
      , #{errCntn}
      , #{lastDecdSq}
      , SYSDATE
      , #{hndEmpno}
      , #{hndTmnlNo}
      , #{hndTrId}
      , #{guid}
    )
  </insert>

  <!-- 승인요청중 상태관리 -->
  <update id="updateDecd" parameterType="com.nanuri.rams.business.common.dto.IBIMS231BDTO">
    UPDATE IBIMS231B
       SET DECD_STEP_DCD = #{decdStepDcd}
         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(decdSttsDcd)">
         , DECD_STTS_DCD = #{decdSttsDcd}
         </if>
         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(apvlRqstCntn)">
         , APVL_RQST_CNTN = #{apvlRqstCntn}
         </if>
         <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(errCntn)">
         , ERR_CNTN = #{errCntn}
         </if>
         , RQST_CNCL_DTM = CASE 
                           WHEN #{decdSttsDcd} = '4' THEN SYSDATE 
                           ELSE NULL 
                            END
         , HND_EMPNO = #{hndEmpno}
         , HND_DETL_DTM = SYSDATE
     WHERE 1=1
       AND DECD_SN IN (
                      SELECT DECD_SN
                        FROM IBIMS231B
                       WHERE 1=1
                         AND DEAL_NO = #{dealNo}
                         AND PRDT_CD = #{prdtCd}
                         AND DECD_JOB_DCD = (
                                               SELECT CD_VL_ID
                                                 FROM IBIMS002B
                                               WHERE 1=1
                                                 AND CMNS_CD_GRP = 'D005'
                                                 AND RSLT_CD_VL = #{decdJobDcd}
                                               )
                         AND SCRN_NO = #{scrnNo}
                         AND EXC_SEQ = #{excSeq}
                         AND RQST_SQ = #{rqstSq}
                         AND TR_SEQ = #{trSeq}
                         AND RQST_CNCL_DTM IS NULL
                         AND PRCS_RSLT_DCD = '00'
                         AND DECD_STEP_DCD = '04'
                         AND DECD_STTS_DCD = '1'
                      )
  </update>

</mapper>